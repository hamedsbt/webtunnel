name: WebTunnel for Android

on:
  schedule:
    - cron: "0 0 1,11,21 * *"

permissions:
  contents: write

env:
  NDK_ZIP_URL: https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
  NDK_DIRNAME: android-ndk-r26d
  ANDROID_API_LEVEL: 30

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [386, amd64, armv7]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Clone WebTunnel repository
        run: |
          git clone --quiet https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/webtunnel.git

      - name: Determine version
        run: |
          cd webtunnel
          git fetch --tags --quiet
          VERSION=$(git tag --sort=-v:refname | head -n1 | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - uses: actions/setup-go@v5
        with:
          go-version: '^1.22'

      - name: Install Android NDK
        run: |
          wget -q $NDK_ZIP_URL -O ndk.zip
          unzip -q ndk.zip -d $HOME
          echo "NDK_HOME=$HOME/${NDK_DIRNAME}" >> $GITHUB_ENV

      - name: Build for ${{ matrix.arch }}
        shell: bash
        run: |
          set -euo pipefail

          case "${{ matrix.arch }}" in
            386)
              GOARCH=386
              CC=i686-linux-android${ANDROID_API_LEVEL}-clang
              CXX=i686-linux-android${ANDROID_API_LEVEL}-clang++
              ARCH_NAME=386
              ;;
            amd64)
              GOARCH=amd64
              CC=x86_64-linux-android${ANDROID_API_LEVEL}-clang
              CXX=x86_64-linux-android${ANDROID_API_LEVEL}-clang++
              ARCH_NAME=amd64
              ;;
            armv7)
              GOARCH=arm
              GOARM=7
              CC=armv7a-linux-androideabi${ANDROID_API_LEVEL}-clang
              CXX=armv7a-linux-androideabi${ANDROID_API_LEVEL}-clang++
              ARCH_NAME=armv7
              ;;
          esac

          TOOLCHAIN="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          export PATH="$TOOLCHAIN/bin:$PATH"
          export CGO_ENABLED=1 GOOS=android GOARCH=$GOARCH GOARM=${GOARM:-}
          export CC CXX

          cd webtunnel/main/client
          go build -ldflags="-s -w" -o webtunnel-client

          OUT="webtunnel-android-${ARCH_NAME}-v${VERSION}.tar"
          tar -cf "$OUT" webtunnel-client
          mv "$OUT" "$GITHUB_WORKSPACE/"

          echo "PACKAGED=$OUT" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: webtunnel-${{ matrix.arch }}
          path: ${{ env.PACKAGED }}

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Clone WebTunnel repository
        run: |
          git clone --quiet https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/webtunnel.git

      - name: Determine version
        run: |
          cd webtunnel
          git fetch --tags --quiet
          VERSION=$(git tag --sort=-v:refname | head -n1 | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Git tag if missing
        run: |
          git fetch --tags
          if ! git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            git tag "v${VERSION}"
            git push origin "v${VERSION}"
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          prerelease: true
          files: artifacts/**/*.tar
